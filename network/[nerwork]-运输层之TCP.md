### TCP的主要特点

1. TCP 是面向连接的传输层服务；即在使用之前需要先建立连接，在传输完成之后需要释放连接。
2. 每一条TCP连接只能有两个端点；TCP传输是点对点的。
3. TCP 提供可靠可靠交付的服务；即无差错，不丢失，不重复，有序传输。
4. TCP 提供全双工交互；即建立TCP连接的通信双方任何时候都可以向对方发送数据。
5. 面向字节流的传输，而不是数据块。

TCP和UDP在发送报文时的方式完全不同，UDP是将上层交付的报文原封不动的加上首部后发送；而TCP不管上层交付的数据报有多长，它是根据对方给出的
窗口值和当时的网络拥塞情况决定的。

### TCP的连接

每一条TCP的连接都有两个端点，那么这个端点指的是的什么？不是IP地址，也不是进程端口号；TCP的连接端点叫做套接字（Socket）。由端口号拼接到
IP地址后面构成，即IP:port; ** 同一个IP地址可以有多个TCP连接，同一个端口号也可以出现在不同的TCP连接中。**

### 可靠传输的工作原理(确认和重传)

理想的情况下可以不采取任何措施就可以实现可靠传输：

1. 传输层信道不产生任何差错
2. 不管发送方以多快的速度发送数据，接收方总是来得及处理

但是现实总是骨感的，那么我们就需要一些可靠的传输协议来完成可靠传输。当传输发生错误时，要求发送方重传出错的数据；当接收方来不及处理时，及时
告诉发送方降低发送数据的速度。

#### 1. 停止等待协议

"停止等待协议"每发送一个分组就停下来等待确认，在收到确认后再发送下一个分组。

1. 无差错情况
发送方每发送一个分组，接收方就确认一个分组，中间不产生误差，直到数据传输完成。
2. 出现差错
发送方发送的数据或者接收方的确认在传输的过程中丢失了，导致数据传输出现误差，那么此时在发送方就需要有一个计时器，当超出规定的时间没有收到
确认时，就重新传输丢失的数据。

此时需要注意三个问题：

    1. 发送方发送完一组数据之后，需要保留数据的副本，以备在数据丢失时重传。
    2. 分组和确认分组都需要编号，这样才知道哪组数据是否正确传输。
    3. 超时重传计时器应该比数据往返的时间更长一点。
    
3. 确认丢失和确认迟到
确认丢失是发送方发送的数据接收方收到并且确认了，但是确认在传输中没有到达发送方，那么发送方会重传该数据，然后接受方又收到了同样的数据；
确认迟到是在上述过程中的确认并没有丢失，只是网络延迟了，那么发送方对发出的两份数据都收到了相同的确认。对于这两种情况，协议都是将重复的数据进行
丢弃，是该确认还是确认，该重传还是重传。
4. 信道利用率
每发送一个分组就等待半天，搞不好还要重传，因此该协议的信道利用率很低。为了提高信道利用率，可以采用流水线传输，这样发送方可以一次传输多个分组。

#### 2. 连续ARQ协议

发送方维持一个发送窗口，每一次发送在窗口内的所有分组，以提高信道利用率。连续ARQ协议规定，每收到一次确认，窗口就向前滑动一个分组的位置。
接收方采取累积确认的方式，只对按序到达的最后一个分组进行确认；但是很明显的一个缺点是无法解决确认丢失和确认重传。所以当发生错误时，需要从
最后一个确认收到的分组开始重传。这就是go_back_N.当通信线路不好时，该协议的效率也不高。

### TCP报文段的首部格式

TCP报文分为数据和首部两部分，主要的功能都在首部体现。

TCP报文段首部的前20个字节是固定的，后面的4n个字节是根据需求添加的。因此TCP报文段首部的最小长度是20个字节。

TCP首部固定的字段及含义如下表：

字段含义 | 字节大小 | 含义说明 |
 -|-|-|
源端口| 2| 发送方的端口 | 
目的端口 | 2 | 接收方的端口 |
序号 | 4 | 序号范围是 0 到 2 的 32 次方 减 1，在TCP中传输的每一个字节都需要编号，起始序号在连接建立时设置 |
确认号 | 4 | 是期望收到对方下一个报文段的第一个字节序号|
数据偏移 | 4 | TCP报文段数据段起始处离TCP报文段的距离，TCP报文首部的最大长度是60字节|
保留  | 6位(不足一个字节) | 保留的位置，目前为0 |
紧急URG | 1 | 当紧急指针URG=1时，表示有紧急报文需要发送，无需像其他报文一样排在缓存的后面，需要配合首部的紧急指针字段使用|
确认ACK | 1 | 只有ACK=1时，确认号字段才有效，TCP规定，连接建立后所有传输的报文都需要将ACK=1 |
推送PSH | 1 | 两个进程进行交互通信时，设置PSH=1，那么接收方会马上处理并回应|
复位RST | 1 | RST=1时。表示TCP连接出现严重错误，必须释放连接，重新连接|
同步SYN | 1 | 在建立连接时用来同步序号，当SYN=1，ACK=0时，表示这是一个连接请求，同意就回复一个SYN=1，ACK=1|
终止FIN | 1 | 释放一个连接，FIN=1表示数据传输完毕，要求释放连接|
窗口 | 2 | 发送方的接收窗口，是接收方设置发送窗口的依据 |
校验和 | 2 | 检验首部和数据两部分 | 
紧急指针 | 2 | 当URG=1时才有效，表示紧急数据的字节数，当窗口值为0时，也可以发送紧急数据|
选项 | 可变，最长40 | 典型的是：最大报文段长度MMS，MMS只是数据部分的最大长度，MMS + 首部字段的长度 = TCP报文段的长度|

TCP首部字段的选项：
- 最大报文段长度(MMS)：设置MMS的目的是提高数据资源利用率，因为每一个TCP报文段至少需要加上40个字节的首部，如果数据部分太少的话，得不偿失。因此MMS尽可能大，
原则是IP层不对其分片为最佳。默认是536个字节。在互联网所有主机都能结束的长度为 536 + 20 = 556 个字节。
- 窗口扩大选项：占3个字节，其中一个字节表示移位值S，那么窗口位数就为16+S，S的最大取值为14，即窗口最大值为 2 的 32 次方 减1；
- 时间戳：占10个字节，主要完成两个功能，一是计算往返时间RTT的，二是防止TCP序号超出范围的；
- 选择确认(SACK):

### TCP 可靠传输的实现

#### 1. 以字节为单位的滑动窗口协议

TCP的滑动窗口是以字节为单位。

#### 2. 超时重传时间的选择

将报文段发出到收到确认的时间差叫做 RTT ，每发出一次报文就采集一次样本，超时重传的时间就是 RTT 的加权平均值；并在每次重传之后，就把超时重传的值加大一些。

#### 3. 选择确认SACK

之间的接收方对数据的接收确认都是最后一个按序到达的序号，导师许多数据都要重传，大大的浪费了资源；而选择确认就是避免已经接收的数据再次重传。
在TCP两端建立连接时，就协议好SACK字段，这样在数据序号没有按序到达时，就将数据序号的边界值告诉发送方；但是却没有规定发送方怎么处理，所以我们现在的策略仍然是
重传所有未被确认的字段。

### TCP的流量控制

#### 1. 利用滑动窗口实现流量控制

#### 2. TCP的传输效率

- 少数据量的发送策略：比如每次只发送一个字节，那么第一次发送之后就把之后的数据缓存起来，等到一定大小再一次性发送；
- 接收方处理数据慢的策略：比如接收方每次只处理一个字节，然后每次回复确认窗口值就一次字节，也是可以缓存等待，大小合适再回复确认。

### TCP的拥塞控制

#### 2. TCP的拥塞控制方法

- 慢开始、拥塞避免、快重传、快恢复

慢开始：由小到大逐渐增大发送窗口的值。成倍的增加，当达到某一个门限值后，采用拥塞避免算法。

拥塞避免：每经纶一个传输轮次过后，将窗口值加一。加法增加。

当网络中出现超时情况时，就判断为网络拥塞，将门限值减小到原来的一半(乘法减小)，并重新执行慢开始算法。

为了了提高效率，对于个别报文的超时情况，我们采用快重传的算法，

### TCP的运输连接管理

#### 1. TCP的连接建立

![TCPconnection](https://github.com/ytuan996/notebook/blob/master/network/image/tcp_connection.png?raw=true)







